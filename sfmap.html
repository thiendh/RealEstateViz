<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.8/d3.min.js"></script>
  <style>
    circle.airbnb {
      fill: #e00007;
      opacity: 0.6;
    }
  </style>
  <script>
    function draw(geo_data) {
    "use strict";

    /*
    D3.js setup code
    */

    var margin = 75,
        width = 960 - margin,
        height = 500 - margin;

    // append SVG to page
    var svg = d3.select("body")
        .append("svg")
          .attr("width", width + margin)
          .attr("height", height + margin)
        .append('g')
          .attr('class', 'map');

    // create a projection properly scaled for SF
    var projection = d3.geo.mercator()
                          .center([-122.433701, 37.767683])
                          .scale(170000)
                          .translate([width / 1.95, height / 1.65]);

    // create a path to draw the neighborhoods
    var path = d3.geo.path()
                     .projection(projection);

    // create and append the map of SF neighborhoods
    var map = svg.selectAll('path')
                 .data(geo_data.features)
                 .enter()
                 .append('path')
                 .attr('d', path)
                 .style('fill', '#eee')
                 .style('stroke', 'black')
                 .style('stroke-width', 1);

    // normalize neighborhood names
    map.datum(function(d) {
      var normalized = d.properties.neighbourhood
                        .replace(/ /g, '_')
                        .replace(/\//g, '_');

      d.properties.neighbourhood = normalized;
      return d;
    });

    // add the neighborhood name as its class
    map.attr('class', function(d) {
                    return d.properties.neighbourhood;
                 });

    // load the listing per neighborhood dataset
    d3.json("http://jay-oh-en.github.io/interactive-data-viz/data/airbnb/listing_count.json", function(data) {
        // find the min/max of listing per neighborhood
        var listings_extent = d3.extent(d3.values(data));

        // append a bubble to each neighborhood
        var bubbles = svg.append("g")
               .attr("class", "bubble")
               .selectAll("circle")
               .data(geo_data.features)
               .enter()
               .append("circle")
               .attr('class', 'airbnb');

        // add the listing data to each neighborhood datum
        bubbles.datum(function(d) {
          d.count = data[d.properties.neighbourhood];
          return d;
        });
    });
    }
  </script>
</head>
<body>
  <script>
    // load neighborhood data
    d3.json("http://jay-oh-en.github.io/interactive-data-viz/data/airbnb/neighbourhoods.geojson", draw);
  </script>
</body>
</html>
